# Release 4.7.1 — Transactions Phase 1 (Buy/Sell)

Date: 2025-09-13

## Summary

This release introduces a new transactions journal for buy/sell trades using a header + two-leg model (cash + instrument). It includes a large, standard UI, clear validation and logging, and DB migrations using dbmate.

Positions (custody and cash) remain snapshot-driven (PositionReports). Trades do NOT update those snapshots; the journal is for P&L and audit.

## Database Migrations

- 032_trades_schema.sql: Adds `Trade` (header) and `TradeLeg` (two legs per trade) plus indexes
- 033_db_version_4_27.sql: Bumps `Configuration.db_version` to `4.27`

Run migrations (example):

```bash
DATABASE_URL="sqlite:/Users/<you>/Library/Containers/com.rene.DragonShield/Data/Library/Application Support/DragonShield/dragonshield.sqlite" \
  dbmate --migrations-dir DragonShield/db/migrations up
```

Verify:

```sql
SELECT value FROM Configuration WHERE key='db_version'; -- should be 4.27
SELECT name FROM sqlite_master WHERE type='table' AND name IN ('Trade','TradeLeg');
```

## UI/UX

- Transactions (Management → Transactions):
  - New, Edit, Reverse, Delete trades
  - Search and refresh
  - Info banner clarifies trades do not update snapshots (P&L only)
- Trade Form:
  - Large form with date, type, instrument, custody account (CUSTODY only), cash account (filtered to instrument currency)
  - Fees/Commission in CHF (converted to cash currency using latest FX on/before trade date)
  - Preview shows cash/instrument deltas and “FX used (rate/date)”
  - Inline holdings next to account pickers + a holdings section showing current → updated

## Notes

- Current balances in the form read snapshots from `PositionReports` at the latest `report_date <= trade_date`.
- CASH leg uses the CASH instrument associated with the selected cash account’s currency.
- Extensive error logs are written to console and `import.log`.

